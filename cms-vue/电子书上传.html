<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>电子书上传 | Notes</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="自我学习">
    
    <link rel="preload" href="/study-notes/assets/css/0.styles.f313a13a.css" as="style"><link rel="preload" href="/study-notes/assets/js/app.039e21f8.js" as="script"><link rel="preload" href="/study-notes/assets/js/2.c66ffe4c.js" as="script"><link rel="preload" href="/study-notes/assets/js/35.0216b661.js" as="script"><link rel="prefetch" href="/study-notes/assets/js/10.1f4a0ba6.js"><link rel="prefetch" href="/study-notes/assets/js/11.3f135838.js"><link rel="prefetch" href="/study-notes/assets/js/12.6d5c0016.js"><link rel="prefetch" href="/study-notes/assets/js/13.385e80e5.js"><link rel="prefetch" href="/study-notes/assets/js/14.0abbf9c6.js"><link rel="prefetch" href="/study-notes/assets/js/15.f1a675c1.js"><link rel="prefetch" href="/study-notes/assets/js/16.cff045ba.js"><link rel="prefetch" href="/study-notes/assets/js/17.1b9fa201.js"><link rel="prefetch" href="/study-notes/assets/js/18.15b4e5fe.js"><link rel="prefetch" href="/study-notes/assets/js/19.96819d01.js"><link rel="prefetch" href="/study-notes/assets/js/20.3d35b0e0.js"><link rel="prefetch" href="/study-notes/assets/js/21.b1b57cb8.js"><link rel="prefetch" href="/study-notes/assets/js/22.33771dfd.js"><link rel="prefetch" href="/study-notes/assets/js/23.a732b160.js"><link rel="prefetch" href="/study-notes/assets/js/24.24b15227.js"><link rel="prefetch" href="/study-notes/assets/js/25.69c4ed30.js"><link rel="prefetch" href="/study-notes/assets/js/26.78ff0822.js"><link rel="prefetch" href="/study-notes/assets/js/27.fe95212f.js"><link rel="prefetch" href="/study-notes/assets/js/28.7ad1509a.js"><link rel="prefetch" href="/study-notes/assets/js/29.61218e4f.js"><link rel="prefetch" href="/study-notes/assets/js/3.63146466.js"><link rel="prefetch" href="/study-notes/assets/js/30.f23314bb.js"><link rel="prefetch" href="/study-notes/assets/js/31.cdae011c.js"><link rel="prefetch" href="/study-notes/assets/js/32.60127ca6.js"><link rel="prefetch" href="/study-notes/assets/js/33.ff9cf28d.js"><link rel="prefetch" href="/study-notes/assets/js/34.7746944f.js"><link rel="prefetch" href="/study-notes/assets/js/36.fcf7055f.js"><link rel="prefetch" href="/study-notes/assets/js/37.6e2d7c68.js"><link rel="prefetch" href="/study-notes/assets/js/38.a9661128.js"><link rel="prefetch" href="/study-notes/assets/js/39.f25b8af3.js"><link rel="prefetch" href="/study-notes/assets/js/4.1b408ca5.js"><link rel="prefetch" href="/study-notes/assets/js/40.b2812eac.js"><link rel="prefetch" href="/study-notes/assets/js/41.e63c192c.js"><link rel="prefetch" href="/study-notes/assets/js/42.91310054.js"><link rel="prefetch" href="/study-notes/assets/js/43.195adb7b.js"><link rel="prefetch" href="/study-notes/assets/js/44.b82e0971.js"><link rel="prefetch" href="/study-notes/assets/js/45.54e35d71.js"><link rel="prefetch" href="/study-notes/assets/js/46.4b06e4d8.js"><link rel="prefetch" href="/study-notes/assets/js/47.c58d11ab.js"><link rel="prefetch" href="/study-notes/assets/js/48.69319e05.js"><link rel="prefetch" href="/study-notes/assets/js/49.81df32c4.js"><link rel="prefetch" href="/study-notes/assets/js/5.45c26daa.js"><link rel="prefetch" href="/study-notes/assets/js/50.b86cd1f2.js"><link rel="prefetch" href="/study-notes/assets/js/51.48962766.js"><link rel="prefetch" href="/study-notes/assets/js/52.d5814608.js"><link rel="prefetch" href="/study-notes/assets/js/53.12683cf2.js"><link rel="prefetch" href="/study-notes/assets/js/54.7f8f2a18.js"><link rel="prefetch" href="/study-notes/assets/js/55.397b6083.js"><link rel="prefetch" href="/study-notes/assets/js/56.ab7945ea.js"><link rel="prefetch" href="/study-notes/assets/js/57.d03d45cb.js"><link rel="prefetch" href="/study-notes/assets/js/58.bae8dfce.js"><link rel="prefetch" href="/study-notes/assets/js/59.c7d972b0.js"><link rel="prefetch" href="/study-notes/assets/js/6.ceefd9a6.js"><link rel="prefetch" href="/study-notes/assets/js/60.50c38210.js"><link rel="prefetch" href="/study-notes/assets/js/61.2d11d07c.js"><link rel="prefetch" href="/study-notes/assets/js/62.6b2af576.js"><link rel="prefetch" href="/study-notes/assets/js/63.826c65fe.js"><link rel="prefetch" href="/study-notes/assets/js/64.9960e579.js"><link rel="prefetch" href="/study-notes/assets/js/65.ff4ea3f1.js"><link rel="prefetch" href="/study-notes/assets/js/66.f6631330.js"><link rel="prefetch" href="/study-notes/assets/js/67.d010895e.js"><link rel="prefetch" href="/study-notes/assets/js/68.55195346.js"><link rel="prefetch" href="/study-notes/assets/js/69.05dc4f2e.js"><link rel="prefetch" href="/study-notes/assets/js/7.22afd591.js"><link rel="prefetch" href="/study-notes/assets/js/70.9b1fb209.js"><link rel="prefetch" href="/study-notes/assets/js/71.eff503c4.js"><link rel="prefetch" href="/study-notes/assets/js/72.1c282bd5.js"><link rel="prefetch" href="/study-notes/assets/js/73.6258956d.js"><link rel="prefetch" href="/study-notes/assets/js/74.8debcd50.js"><link rel="prefetch" href="/study-notes/assets/js/75.4cef4522.js"><link rel="prefetch" href="/study-notes/assets/js/76.b4268a30.js"><link rel="prefetch" href="/study-notes/assets/js/77.0ec777b3.js"><link rel="prefetch" href="/study-notes/assets/js/8.c8a1b87b.js"><link rel="prefetch" href="/study-notes/assets/js/9.f05e9459.js">
    <link rel="stylesheet" href="/study-notes/assets/css/0.styles.f313a13a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-notes/" class="home-link router-link-active"><!----> <span class="site-name">Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-notes/koa2/restful.html" class="nav-link">
  koa2
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/design-patterns/面向对象_01.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/interview-advanced/mind-mapping.html" class="nav-link">
  能力进阶
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/cms-vue/advance.html" class="nav-link">
  vue koa 实现后台管理
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/HTTP/了解HTTP协议.html" class="nav-link">
  HTTP协议
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/node/Node.js在前后端的区别.html" class="nav-link">
  node应用开发
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-notes/koa2/restful.html" class="nav-link">
  koa2
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/design-patterns/面向对象_01.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/interview-advanced/mind-mapping.html" class="nav-link">
  能力进阶
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/cms-vue/advance.html" class="nav-link">
  vue koa 实现后台管理
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/HTTP/了解HTTP协议.html" class="nav-link">
  HTTP协议
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/node/Node.js在前后端的区别.html" class="nav-link">
  node应用开发
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>vue koa 实现后台管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-notes/cms-vue/advance.html" class="sidebar-link">Vue进阶</a></li><li><a href="/study-notes/cms-vue/vuex-vue-router.html" class="sidebar-link">Vuex 和 Vue-router 进阶</a></li><li><a href="/study-notes/cms-vue/前端框架搭建.html" class="sidebar-link">前端框架搭建</a></li><li><a href="/study-notes/cms-vue/后端框架搭建.html" class="sidebar-link">后端框架搭建</a></li><li><a href="/study-notes/cms-vue/功能分析.html" class="sidebar-link">功能分析</a></li><li><a href="/study-notes/cms-vue/登录页.html" class="sidebar-link">用户登录</a></li><li><a href="/study-notes/cms-vue/路由和权限校验.html" class="sidebar-link">路由和权限校验</a></li><li><a href="/study-notes/cms-vue/侧边栏.html" class="sidebar-link">侧边栏</a></li><li><a href="/study-notes/cms-vue/重定向.html" class="sidebar-link">重定向</a></li><li><a href="/study-notes/cms-vue/面包屑导航.html" class="sidebar-link">面包屑导航</a></li><li><a href="/study-notes/cms-vue/电子书上传.html" class="active sidebar-link">电子书上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#上传-api" class="sidebar-link">上传 API</a></li><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#电子书解析" class="sidebar-link">电子书解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#创建-book-表结构" class="sidebar-link">创建 book 表结构</a></li><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#从文件创建-book-对象" class="sidebar-link">从文件创建 Book 对象</a></li><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#数据创建-book-对象" class="sidebar-link">数据创建 Book 对象</a></li><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#epub解析应用" class="sidebar-link">epub解析应用</a></li><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#电子书解压" class="sidebar-link">电子书解压</a></li><li class="sidebar-sub-header"><a href="/study-notes/cms-vue/电子书上传.html#电子书目录解析" class="sidebar-link">电子书目录解析</a></li></ul></li></ul></li><li><a href="/study-notes/cms-vue/电子书新增.html" class="sidebar-link">电子书新增</a></li><li><a href="/study-notes/cms-vue/电子书编辑.html" class="sidebar-link">电子书编辑</a></li><li><a href="/study-notes/cms-vue/电子书列表.html" class="sidebar-link">电子书列表</a></li><li><a href="/study-notes/cms-vue/项目部署.html" class="sidebar-link">项目部署</a></li><li><a href="/study-notes/cms-vue/常用命令.html" class="sidebar-link">常用命令</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="电子书上传"><a href="#电子书上传" class="header-anchor">#</a> 电子书上传</h1> <h2 id="上传-api"><a href="#上传-api" class="header-anchor">#</a> 上传 API</h2> <p>上传这里我们使用已经安装好的 <code>koa-body</code>，设置相关参数即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> KoaBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-body'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> uploadDir<span class="token operator">:</span> <span class="token punctuation">{</span> booksDir <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@config'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token function">KoaBody</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        multipart<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 支持文件上传</span>
        formidable<span class="token operator">:</span> <span class="token punctuation">{</span>
            uploadDir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> booksDir<span class="token punctuation">)</span><span class="token punctuation">,</span>
            keepExtensions<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 保留拓展名</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><ul><li><code>booksDir</code></li></ul> <p>指定目的 nginx 上传路径，这样做的好处是一旦电子书拷贝到指定目录下后，就可以通过 nginx 生成下载链接：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">chooseDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isDev <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span>
    <span class="token keyword">return</span> isDev <span class="token operator">?</span> <span class="token string">'/Users/xxxx'</span> <span class="token operator">:</span> <span class="token string">'/root'</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    uploadDir<span class="token operator">:</span> <span class="token punctuation">{</span>
        booksDir<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">chooseDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/upload/admin-upload-ebook/book</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        uploadOrigin<span class="token operator">:</span> <span class="token string">'http://localhost:8089/admin-upload-ebook/book/'</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>upload</code> API 编写</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Result <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@lib/result'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> uploadDir<span class="token operator">:</span> <span class="token punctuation">{</span> uploadOrigin <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@config'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">BooksCtl</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> file <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>file
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file <span class="token operator">||</span> file<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token string">'上传电子书失败'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> book <span class="token operator">=</span> <span class="token keyword">await</span> Book<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span> <span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooksCtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><code>upload</code> API 路由引用，值得注意的是，这里上传也要做鉴权处理，防止开放上传</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token string">'/v1/book'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> upload <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@controller/v1/books'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Auth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@middlewares/auth'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">,</span> upload<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><h2 id="电子书解析"><a href="#电子书解析" class="header-anchor">#</a> 电子书解析</h2> <h3 id="创建-book-表结构"><a href="#创建-book-表结构" class="header-anchor">#</a> 创建 book 表结构</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Sequelize<span class="token punctuation">,</span> Model<span class="token punctuation">,</span> DataTypes<span class="token punctuation">,</span> Op <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@core/db'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

Book<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
            primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        fileName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        cover<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        title<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        author<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        publisher<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        bookId<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        category<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
        categoryText<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        language<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        rootFile<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        originalName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        filePath<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        unzipPath<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        coverPath<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        createUser<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        createDt<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">BIGINT</span><span class="token punctuation">,</span>
            defaultValue<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        updateDt<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">BIGINT</span><span class="token punctuation">,</span>
            defaultValue<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        updateType<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
            defaultValue<span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        sequelize<span class="token punctuation">,</span>
        tableName<span class="token operator">:</span> <span class="token string">'book'</span><span class="token punctuation">,</span>
        timestamps<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> Book <span class="token punctuation">}</span>
</code></pre></div><p>处理解析完成的电子书基础数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> basicData <span class="token operator">=</span> Book<span class="token punctuation">.</span><span class="token function">_createBookFromFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token keyword">const</span> epubData <span class="token operator">=</span> <span class="token keyword">await</span> EpubParse<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>basicData<span class="token punctuation">,</span> <span class="token operator">...</span>epubData <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Book 对象分为两种场景，第一种是直接从电子书文件中解析出 Book 对象，第二种是从 data 对象中生成 Book 对象，因此我们要分开处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">addBook</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新增电子书</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">updateBook</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 编辑电子书</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="从文件创建-book-对象"><a href="#从文件创建-book-对象" class="header-anchor">#</a> 从文件创建 Book 对象</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token keyword">static</span> <span class="token function">_createBookFromFile</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> url<span class="token punctuation">,</span> unzipUrl <span class="token punctuation">}</span> <span class="token operator">=</span> Book<span class="token punctuation">.</span><span class="token function">_handleFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            fileName<span class="token operator">:</span> fileName<span class="token punctuation">,</span>
            path<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/book/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// epub文件相对路径</span>
            filePath<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/book/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// epub文件路径</span>
            url<span class="token operator">:</span> url<span class="token punctuation">,</span> <span class="token comment">// epub文件url</span>
            title<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 标题</span>
            author<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 作者</span>
            publisher<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 出版社</span>
            contents<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 目录</span>
            cover<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 封面图片URL</span>
            category<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 分类ID</span>
            categoryText<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 分类名称</span>
            language<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 语种</span>
            unzipPath<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/unzip/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 解压后的电子书目录</span>
            unzipUrl<span class="token operator">:</span> unzipUrl<span class="token punctuation">,</span> <span class="token comment">// 解压后的电子书链接</span>
            originalName<span class="token operator">:</span> file<span class="token punctuation">.</span>name <span class="token comment">// 原文件名</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>_handleFile</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">_handleFile</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token comment">// 文件上传名</span>
    <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token comment">// 本地文件路径</span>
    <span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token comment">// 后缀</span>
    <span class="token keyword">const</span> fileName <span class="token operator">=</span> basename<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>extname<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment">// 文件无后缀的name</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/book/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 下载URL</span>
    <span class="token keyword">const</span> unzipPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>booksDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/unzip/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 解压后文件夹路径</span>
    <span class="token keyword">const</span> unzipUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/unzip/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 解压后文件夹路径URL</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>unzipPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>unzipPath<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 创建电子书解压后的目录</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        basename<span class="token punctuation">,</span>
        fileName<span class="token punctuation">,</span>
        url<span class="token punctuation">,</span>
        unzipUrl
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="数据创建-book-对象"><a href="#数据创建-book-对象" class="header-anchor">#</a> 数据创建 Book 对象</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token keyword">static</span> <span class="token function">_createBookFromData</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            fileName<span class="token operator">:</span> data<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
            cover<span class="token operator">:</span> data<span class="token punctuation">.</span>coverPath<span class="token punctuation">,</span>
            title<span class="token operator">:</span> data<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
            author<span class="token operator">:</span> data<span class="token punctuation">.</span>author<span class="token punctuation">,</span>
            publisher<span class="token operator">:</span> data<span class="token punctuation">.</span>publisher<span class="token punctuation">,</span>
            bookId<span class="token operator">:</span> data<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
            language<span class="token operator">:</span> data<span class="token punctuation">.</span>language<span class="token punctuation">,</span>
            rootFile<span class="token operator">:</span> data<span class="token punctuation">.</span>rootFile<span class="token punctuation">,</span>
            originalName<span class="token operator">:</span> data<span class="token punctuation">.</span>originalName<span class="token punctuation">,</span>
            path<span class="token operator">:</span> data<span class="token punctuation">.</span>path <span class="token operator">||</span> data<span class="token punctuation">.</span>filePath<span class="token punctuation">,</span>
            filePath<span class="token operator">:</span> data<span class="token punctuation">.</span>path <span class="token operator">||</span> data<span class="token punctuation">.</span>filePath<span class="token punctuation">,</span>
            unzipPath<span class="token operator">:</span> data<span class="token punctuation">.</span>unzipPath<span class="token punctuation">,</span>
            coverPath<span class="token operator">:</span> data<span class="token punctuation">.</span>coverPath<span class="token punctuation">,</span>
            createUser<span class="token operator">:</span> data<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            createDt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            updateDt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            updateType<span class="token operator">:</span> data<span class="token punctuation">.</span>updateType <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> data<span class="token punctuation">.</span>updateType <span class="token operator">:</span> <span class="token constant">UPDATE_TYPE_FROM_WEB</span><span class="token punctuation">,</span>
            contents<span class="token operator">:</span> data<span class="token punctuation">.</span>contents
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="epub解析应用"><a href="#epub解析应用" class="header-anchor">#</a> epub解析应用</h3> <p>初始化后，可以调用 Book 实例的 parse 方法解析电子书，这里我们使用了 epub 库，我们直接将 epub 库源码集成到项目中：</p> <h4 id="epub-库集成"><a href="#epub-库集成" class="header-anchor">#</a> epub 库集成</h4> <p>epub 库源码：<a href="https://github.com/julien-c/epub" target="_blank" rel="noopener noreferrer">https://github.com/julien-c/epub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，我们直接将 <code>epub.js</code> 拷贝到 <code>/core/epub.js</code></p> <h4 id="epub-库获取图片逻辑修改"><a href="#epub-库获取图片逻辑修改" class="header-anchor">#</a> epub 库获取图片逻辑修改</h4> <p>修改获取图片的源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">getImage</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manifest<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manifest<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'media-type'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'image/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid mime type for image'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> coverId <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manifest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>manifest<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>properties <span class="token operator">===</span> <span class="token string">'cover-image'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>coverId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span>coverId<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'File not found'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="使用-epub-库解析电子书"><a href="#使用-epub-库解析电子书" class="header-anchor">#</a> 使用 epub 库解析电子书</h4> <p>通过 <code>epub</code> 库的方法，我们将路径文件传入 <code>Epub</code> 生成 <code>epub</code> 实例，对 <code>epub.on</code> 的 <code>end</code> 事件进行回调处理，在 <code>epub</code> 实例分析发现基础数据在 <code>epub.metadata</code> 对象中，通过对 <code>epub.metadata</code> 解析，我们可以得到图书相关的标题、语言、作者、出版社等信息，之前已经对 <code>epub</code> 自带的 <code>getImage</code> 方法已做修改。</p> <p>通过对 <code>cover</code> 的解析，我们可以得到图书的封面图片，并存储到相关路径，接下来我们将对电子书的内容以及目录做解析。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
* @description 解析当前电子书的信息
* @date 2021-04-25
* @static
* @param {*} file
* @returns
* @memberof EpubParse
*/</span>
<span class="token keyword">static</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> fileName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token keyword">const</span> bookPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/book/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>bookPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span><span class="token string">'电子书资源不存在'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> epub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Epub</span><span class="token punctuation">(</span>bookPath<span class="token punctuation">)</span>
        epub<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        epub<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> title<span class="token punctuation">,</span> language<span class="token punctuation">,</span> creator<span class="token punctuation">,</span> creatorFileAs<span class="token punctuation">,</span> publisher<span class="token punctuation">,</span> cover <span class="token punctuation">}</span> <span class="token operator">=</span> epub<span class="token punctuation">.</span>metadata
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span><span class="token string">'电子书标题不存在，无法解析'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> title
                    <span class="token keyword">this</span><span class="token punctuation">.</span>language <span class="token operator">=</span> language <span class="token operator">||</span> <span class="token string">'en'</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>author <span class="token operator">=</span> creator <span class="token operator">||</span> creatorFileAs <span class="token operator">||</span> <span class="token string">'unknown'</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>publisher <span class="token operator">=</span> publisher <span class="token operator">||</span> <span class="token string">'unknown'</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>rootFile <span class="token operator">=</span> epub<span class="token punctuation">.</span>rootFile
                    <span class="token keyword">const</span> <span class="token function-variable function">handleGetImage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> imgBuffer<span class="token punctuation">,</span> mimeType</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">const</span> imgData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                            <span class="token keyword">const</span> suffix <span class="token operator">=</span> mimeType<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                            <span class="token keyword">const</span> coverPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/img/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>suffix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                            <span class="token keyword">const</span> coverUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/img/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>suffix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                            fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>coverPath<span class="token punctuation">,</span> imgBuffer<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>coverPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/img/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>suffix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>cover <span class="token operator">=</span> coverUrl
                            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        EpubParse<span class="token punctuation">.</span><span class="token function">unzip</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
                        EpubParse<span class="token punctuation">.</span><span class="token function">parseContents</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> epub<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> chapters<span class="token punctuation">,</span> chapterTree <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>contents <span class="token operator">=</span> chapters
                            <span class="token keyword">this</span><span class="token punctuation">.</span>contentsTree <span class="token operator">=</span> chapterTree
                            epub<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span>cover<span class="token punctuation">,</span> handleGetImage<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        epub<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="电子书解压"><a href="#电子书解压" class="header-anchor">#</a> 电子书解压</h3> <p>电子书解析目录我们需要对电子书先进行解压，获取到相关解压文件才可进行下步目录解析。</p> <p>解压文件通过 <code>adm-zip</code> 包进行处理</p> <div class="language-js extra-class"><pre class="language-js"><code>npm i <span class="token operator">-</span><span class="token constant">S</span> adm<span class="token operator">-</span>zip

<span class="token keyword">const</span> AdmZip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'adm-zip'</span><span class="token punctuation">)</span>

<span class="token comment">/**
* @description 解压当前电子书到指定目录
* @date 2021-04-25
* @static
* @param {*} file
* @memberof EpubParse
*/</span>
<span class="token keyword">static</span> <span class="token function">unzip</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> unzipPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token keyword">const</span> zip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdmZip</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/book/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 解析文件路径 --- 绝对路径</span>
    zip<span class="token punctuation">.</span><span class="token function">extractAllTo</span><span class="token punctuation">(</span>unzipPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//解压到当前路径下，并且是否覆盖</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="电子书目录解析"><a href="#电子书目录解析" class="header-anchor">#</a> 电子书目录解析</h3> <p>电子书目录的解析主要通过对电子书解压后的 <code>toc.ncx</code> 文件进行处理，因此我们需要先对 <code>.ncx</code> 文件进行处理，如果 <code>.ncx</code> 文件不存在，那么就没必要进行接下来的目录处理。</p> <p>如果 <code>.ncx</code> 文件存在，我们接下来获取电子书解压后 <code>.ncx</code> 的本地绝对路径，通过 <code>fs.readFileSync</code> 我们读取文件，此时引入 <code>xml2js</code> 文件，处理读取到的 <code>xml</code> 文件：</p> <div class="language-js extra-class"><pre class="language-js"><code>npm i <span class="token operator">-</span><span class="token constant">S</span> xml2js

<span class="token keyword">const</span> xml2js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xml2js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parseString

<span class="token function">xml2js</span><span class="token punctuation">(</span>
    xml<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        explicitArray<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 设置为false时，解析结果不会包裹array</span>
        ignoreAttrs<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 解析属性</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> json</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p><code>xml2js</code> 三个参数，第一个是要处理的 <code>xml</code> 文件，第二个是相关参数配置，第三个是回调函数，我们将在回调函数里处理我们需要解析的目录。</p> <p>通过回调函数可获得 <code>json</code> 数据，在 <code>json.ncx.navMap</code> 我们可以获得具体的章节目录信息，其中 <code>navMap.navPoint</code> 是章节所包含的对象数据，它可能是嵌套目录，里面可能包含多个子目录。</p> <ul><li><code>findParent</code> 处理当前目录的父级目录及规定层次</li> <li><code>flatten</code> 处理将目录转为一维数组</li> <li><code>generateTree</code>  处理将一维数组转化为嵌套树状结构</li> <li><code>filterUselessField</code> 处理过滤对象无用字段</li></ul> <p>通过对原始目录对象数据进行处理后，我们对新的数据进行循环处理，得到我们想要的数据结构返回给客户端进行显示。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
    * @description 解析当前电子书的目录
    * @date 2021-04-25
    * @static
    * @param {*} epub
    * @memberof EpubParse
    */</span>
<span class="token keyword">static</span> <span class="token function">parseContents</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> epub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> fileName<span class="token punctuation">,</span> unzipPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generateFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token comment">// 获取 .ncx 文件名</span>
    <span class="token comment">// .ncx 文件是电子书的目录顺序文件</span>
    <span class="token keyword">function</span> <span class="token function">getNcxFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> manifest <span class="token operator">=</span> epub <span class="token operator">&amp;&amp;</span> epub<span class="token punctuation">.</span>manifest
        <span class="token keyword">const</span> spine <span class="token operator">=</span> epub <span class="token operator">&amp;&amp;</span> epub<span class="token punctuation">.</span>spine
        <span class="token keyword">const</span> ncx <span class="token operator">=</span> manifest <span class="token operator">&amp;&amp;</span> manifest<span class="token punctuation">.</span>ncx
        <span class="token keyword">const</span> toc <span class="token operator">=</span> spine <span class="token operator">&amp;&amp;</span> spine<span class="token punctuation">.</span>toc
        <span class="token keyword">return</span> <span class="token punctuation">(</span>ncx <span class="token operator">&amp;&amp;</span> ncx<span class="token punctuation">.</span>href<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>toc <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
    * @description 查询当前目录的父级目录及规定层次
    * @date 2021-04-26
    * @param {*} array
    * @param {number} [level=0]
    * @param {string} [pid='']
    * @returns
    */</span>
    <span class="token keyword">function</span> <span class="token function">findParent</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> pid <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> array<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 没有包含 navPoint 直接赋值</span>
            item<span class="token punctuation">.</span>level <span class="token operator">=</span> level
            item<span class="token punctuation">.</span>pid <span class="token operator">=</span> pid
            <span class="token comment">// 包含 navPoint 且 navPoint是一个数组</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>navPoint <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>navPoint<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                item<span class="token punctuation">.</span>navPoint <span class="token operator">=</span> <span class="token function">findParent</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>navPoint<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'$'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>navPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// navPoint 是一个对象的时候，说明此时有当前这一个子目录，给子目录添加相应字段</span>
                item<span class="token punctuation">.</span>navPoint<span class="token punctuation">.</span>level <span class="token operator">=</span> level <span class="token operator">+</span> <span class="token number">1</span>
                item<span class="token punctuation">.</span>navPoint<span class="token punctuation">.</span>pid <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'$'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> item
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
    * @description 将目录转为一维数组
    * @date 2021-04-26
    * @param {*} array
    * @returns
    */</span>
    <span class="token keyword">function</span> <span class="token function">flatten</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            <span class="token operator">...</span>array<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>navPoint <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>navPoint<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">flatten</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>navPoint<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>navPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> item<span class="token punctuation">.</span>navPoint<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> item
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
    * @description 将一维数组转化为嵌套树状结构
    * @date 2021-04-26
    * @param {*} array
    * @returns
    */</span>
    <span class="token keyword">function</span> <span class="token function">generateTree</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> trees <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment">// v.pid 不存在 说明这是一个一级目录</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>pid <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                trees<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// v.pid 存在 说明这是一个次级目录，我们需要找到它的父级目录</span>
                <span class="token comment">// 找到 pid 相同的 父级目录， 并将当前目录存入 父级目录的 children</span>
                <span class="token keyword">const</span> parent <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span>navId <span class="token operator">===</span> v<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>
                parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> trees
    <span class="token punctuation">}</span>
    <span class="token comment">/**
    * @description 过滤对象无限用字段
    * @date 2021-04-26
    * @param {*} obj
    * @param {*} array
    */</span>
    <span class="token keyword">function</span> <span class="token function">filterUselessField</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">delete</span> obj<span class="token punctuation">[</span>v<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rootFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span><span class="token string">'电子书目录解析失败'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> ncxFilePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unzipPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getNcxFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token keyword">const</span> xml <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>ncxFilePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token comment">// 读取 ncx 文件</span>
            <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>ncxFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>uploadPath<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment">// 获取 ncx 文件所在目录地址</span>
            <span class="token comment">// 将 ncx 文件从 xml 转化为 json</span>
            <span class="token function">xml2js</span><span class="token punctuation">(</span>
                xml<span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    explicitArray<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 设置为false时，解析结果不会包裹array</span>
                    ignoreAttrs<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 解析属性</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> json</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> navMap <span class="token operator">=</span> json<span class="token punctuation">.</span>ncx<span class="token punctuation">.</span>navMap <span class="token comment">// 获取ncx的navMap属性，里面包含实际的章节目录信息</span>
                        <span class="token comment">// 如果navMap属性不存在navPoint属性，则说明目录不存在</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navMap<span class="token punctuation">.</span>navPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">global<span class="token punctuation">.</span>errs<span class="token punctuation">.</span>NotFound</span><span class="token punctuation">(</span><span class="token string">'目录解析失败，navMap.navPoint error'</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            navMap<span class="token punctuation">.</span>navPoint <span class="token operator">=</span> <span class="token function">findParent</span><span class="token punctuation">(</span>navMap<span class="token punctuation">.</span>navPoint<span class="token punctuation">)</span>
                            <span class="token keyword">const</span> newNavMap <span class="token operator">=</span> <span class="token function">flatten</span><span class="token punctuation">(</span>navMap<span class="token punctuation">.</span>navPoint<span class="token punctuation">)</span>
                            <span class="token keyword">const</span> chapters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                            <span class="token keyword">const</span> uselessField <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">,</span> <span class="token string">'navLabel'</span><span class="token punctuation">,</span> <span class="token string">'navPoint'</span><span class="token punctuation">]</span>
                            <span class="token comment">// epub.flow 是当前电子书的所有目录</span>
                            <span class="token comment">// navMap.navPoint 是当前电子书的嵌套目录，里面可能包含多个子目录</span>
                            <span class="token comment">// newNavMap 需要将当前 navMap.navPoint 展开成一维数组，里面是所有的目录，包含父级目录以及子目录</span>
                            newNavMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chapter<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                <span class="token keyword">const</span> src <span class="token operator">=</span> chapter<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token string">'$'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>src
                                chapter<span class="token punctuation">.</span>label <span class="token operator">=</span> chapter<span class="token punctuation">.</span>navLabel<span class="token punctuation">.</span>text <span class="token operator">||</span> <span class="token string">''</span>
                                chapter<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                                chapter<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 生成章节的URL</span>
                                chapter<span class="token punctuation">.</span>navId <span class="token operator">=</span> chapter<span class="token punctuation">[</span><span class="token string">'$'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id
                                chapter<span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName
                                chapter<span class="token punctuation">.</span>order <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
                                <span class="token function">filterUselessField</span><span class="token punctuation">(</span>chapter<span class="token punctuation">,</span> uselessField<span class="token punctuation">)</span>
                                chapters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chapter<span class="token punctuation">)</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span>
                            <span class="token keyword">const</span> chapterTree <span class="token operator">=</span> <span class="token function">generateTree</span><span class="token punctuation">(</span>chapters<span class="token punctuation">)</span> <span class="token comment">// 将目录转化为树状结构</span>
                            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> chapters<span class="token punctuation">,</span> chapterTree <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">4/27/2021, 7:07:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-notes/cms-vue/面包屑导航.html" class="prev">
        面包屑导航
      </a></span> <span class="next"><a href="/study-notes/cms-vue/电子书新增.html">
        电子书新增
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-notes/assets/js/app.039e21f8.js" defer></script><script src="/study-notes/assets/js/2.c66ffe4c.js" defer></script><script src="/study-notes/assets/js/35.0216b661.js" defer></script>
  </body>
</html>
