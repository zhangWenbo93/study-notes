<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RESTFull 最佳实践 | Notes</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="自我学习">
    
    <link rel="preload" href="/study-notes/assets/css/0.styles.f313a13a.css" as="style"><link rel="preload" href="/study-notes/assets/js/app.039e21f8.js" as="script"><link rel="preload" href="/study-notes/assets/js/2.c66ffe4c.js" as="script"><link rel="preload" href="/study-notes/assets/js/74.8debcd50.js" as="script"><link rel="prefetch" href="/study-notes/assets/js/10.1f4a0ba6.js"><link rel="prefetch" href="/study-notes/assets/js/11.3f135838.js"><link rel="prefetch" href="/study-notes/assets/js/12.6d5c0016.js"><link rel="prefetch" href="/study-notes/assets/js/13.385e80e5.js"><link rel="prefetch" href="/study-notes/assets/js/14.0abbf9c6.js"><link rel="prefetch" href="/study-notes/assets/js/15.f1a675c1.js"><link rel="prefetch" href="/study-notes/assets/js/16.cff045ba.js"><link rel="prefetch" href="/study-notes/assets/js/17.1b9fa201.js"><link rel="prefetch" href="/study-notes/assets/js/18.15b4e5fe.js"><link rel="prefetch" href="/study-notes/assets/js/19.96819d01.js"><link rel="prefetch" href="/study-notes/assets/js/20.3d35b0e0.js"><link rel="prefetch" href="/study-notes/assets/js/21.b1b57cb8.js"><link rel="prefetch" href="/study-notes/assets/js/22.33771dfd.js"><link rel="prefetch" href="/study-notes/assets/js/23.a732b160.js"><link rel="prefetch" href="/study-notes/assets/js/24.24b15227.js"><link rel="prefetch" href="/study-notes/assets/js/25.69c4ed30.js"><link rel="prefetch" href="/study-notes/assets/js/26.78ff0822.js"><link rel="prefetch" href="/study-notes/assets/js/27.fe95212f.js"><link rel="prefetch" href="/study-notes/assets/js/28.7ad1509a.js"><link rel="prefetch" href="/study-notes/assets/js/29.61218e4f.js"><link rel="prefetch" href="/study-notes/assets/js/3.63146466.js"><link rel="prefetch" href="/study-notes/assets/js/30.f23314bb.js"><link rel="prefetch" href="/study-notes/assets/js/31.cdae011c.js"><link rel="prefetch" href="/study-notes/assets/js/32.60127ca6.js"><link rel="prefetch" href="/study-notes/assets/js/33.ff9cf28d.js"><link rel="prefetch" href="/study-notes/assets/js/34.7746944f.js"><link rel="prefetch" href="/study-notes/assets/js/35.0216b661.js"><link rel="prefetch" href="/study-notes/assets/js/36.fcf7055f.js"><link rel="prefetch" href="/study-notes/assets/js/37.6e2d7c68.js"><link rel="prefetch" href="/study-notes/assets/js/38.a9661128.js"><link rel="prefetch" href="/study-notes/assets/js/39.f25b8af3.js"><link rel="prefetch" href="/study-notes/assets/js/4.1b408ca5.js"><link rel="prefetch" href="/study-notes/assets/js/40.b2812eac.js"><link rel="prefetch" href="/study-notes/assets/js/41.e63c192c.js"><link rel="prefetch" href="/study-notes/assets/js/42.91310054.js"><link rel="prefetch" href="/study-notes/assets/js/43.195adb7b.js"><link rel="prefetch" href="/study-notes/assets/js/44.b82e0971.js"><link rel="prefetch" href="/study-notes/assets/js/45.54e35d71.js"><link rel="prefetch" href="/study-notes/assets/js/46.4b06e4d8.js"><link rel="prefetch" href="/study-notes/assets/js/47.c58d11ab.js"><link rel="prefetch" href="/study-notes/assets/js/48.69319e05.js"><link rel="prefetch" href="/study-notes/assets/js/49.81df32c4.js"><link rel="prefetch" href="/study-notes/assets/js/5.45c26daa.js"><link rel="prefetch" href="/study-notes/assets/js/50.b86cd1f2.js"><link rel="prefetch" href="/study-notes/assets/js/51.48962766.js"><link rel="prefetch" href="/study-notes/assets/js/52.d5814608.js"><link rel="prefetch" href="/study-notes/assets/js/53.12683cf2.js"><link rel="prefetch" href="/study-notes/assets/js/54.7f8f2a18.js"><link rel="prefetch" href="/study-notes/assets/js/55.397b6083.js"><link rel="prefetch" href="/study-notes/assets/js/56.ab7945ea.js"><link rel="prefetch" href="/study-notes/assets/js/57.d03d45cb.js"><link rel="prefetch" href="/study-notes/assets/js/58.bae8dfce.js"><link rel="prefetch" href="/study-notes/assets/js/59.c7d972b0.js"><link rel="prefetch" href="/study-notes/assets/js/6.ceefd9a6.js"><link rel="prefetch" href="/study-notes/assets/js/60.50c38210.js"><link rel="prefetch" href="/study-notes/assets/js/61.2d11d07c.js"><link rel="prefetch" href="/study-notes/assets/js/62.6b2af576.js"><link rel="prefetch" href="/study-notes/assets/js/63.826c65fe.js"><link rel="prefetch" href="/study-notes/assets/js/64.9960e579.js"><link rel="prefetch" href="/study-notes/assets/js/65.ff4ea3f1.js"><link rel="prefetch" href="/study-notes/assets/js/66.f6631330.js"><link rel="prefetch" href="/study-notes/assets/js/67.d010895e.js"><link rel="prefetch" href="/study-notes/assets/js/68.55195346.js"><link rel="prefetch" href="/study-notes/assets/js/69.05dc4f2e.js"><link rel="prefetch" href="/study-notes/assets/js/7.22afd591.js"><link rel="prefetch" href="/study-notes/assets/js/70.9b1fb209.js"><link rel="prefetch" href="/study-notes/assets/js/71.eff503c4.js"><link rel="prefetch" href="/study-notes/assets/js/72.1c282bd5.js"><link rel="prefetch" href="/study-notes/assets/js/73.6258956d.js"><link rel="prefetch" href="/study-notes/assets/js/75.4cef4522.js"><link rel="prefetch" href="/study-notes/assets/js/76.b4268a30.js"><link rel="prefetch" href="/study-notes/assets/js/77.0ec777b3.js"><link rel="prefetch" href="/study-notes/assets/js/8.c8a1b87b.js"><link rel="prefetch" href="/study-notes/assets/js/9.f05e9459.js">
    <link rel="stylesheet" href="/study-notes/assets/css/0.styles.f313a13a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-notes/" class="home-link router-link-active"><!----> <span class="site-name">Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-notes/koa2/restful.html" class="nav-link">
  koa2
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/design-patterns/面向对象_01.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/interview-advanced/mind-mapping.html" class="nav-link">
  能力进阶
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/cms-vue/advance.html" class="nav-link">
  vue koa 实现后台管理
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/HTTP/了解HTTP协议.html" class="nav-link">
  HTTP协议
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/node/Node.js在前后端的区别.html" class="nav-link">
  node应用开发
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-notes/koa2/restful.html" class="nav-link">
  koa2
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/design-patterns/面向对象_01.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/interview-advanced/mind-mapping.html" class="nav-link">
  能力进阶
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/cms-vue/advance.html" class="nav-link">
  vue koa 实现后台管理
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/HTTP/了解HTTP协议.html" class="nav-link">
  HTTP协议
</a></li><li class="dropdown-item"><!----> <a href="/study-notes/node/Node.js在前后端的区别.html" class="nav-link">
  node应用开发
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>koa2</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-notes/koa2/restful.html" class="sidebar-link">认识RESTful</a></li><li><a href="/study-notes/koa2/koa1.html" class="sidebar-link">认识Koa</a></li><li><a href="/study-notes/koa2/koa2.html" class="sidebar-link">Koa路由和RESTful实践</a></li><li><a href="/study-notes/koa2/koa3.html" class="sidebar-link">Koa控制器</a></li><li><a href="/study-notes/koa2/error-handling-mechanism.html" class="sidebar-link">多方案错误处理机制</a></li><li><a href="/study-notes/koa2/nosql-mongodb.html" class="sidebar-link">NoSQL和MongoDB</a></li><li><a href="/study-notes/koa2/jwt-koa.html" class="sidebar-link">JWT在Koa的应用</a></li><li><a href="/study-notes/koa2/koa-upload.html" class="sidebar-link">Koa图片上传</a></li><li><a href="/study-notes/koa2/schema.html" class="sidebar-link">数据模型的应用</a></li><li><a href="/study-notes/koa2/restful-practice.html" aria-current="page" class="active sidebar-link">RESTful最佳实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study-notes/koa2/restful-practice.html#嵌套路由" class="sidebar-link">嵌套路由</a></li><li class="sidebar-sub-header"><a href="/study-notes/koa2/restful-practice.html#互斥接口" class="sidebar-link">互斥接口</a></li><li class="sidebar-sub-header"><a href="/study-notes/koa2/restful-practice.html#restful-api最佳实践" class="sidebar-link">RESTful API最佳实践</a></li><li class="sidebar-sub-header"><a href="/study-notes/koa2/restful-practice.html#分页设计、模糊搜索、多字段模糊搜索实践" class="sidebar-link">分页设计、模糊搜索、多字段模糊搜索实践</a></li></ul></li><li><a href="/study-notes/koa2/database-design.html" class="sidebar-link">数据库设计</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="restfull-最佳实践"><a href="#restfull-最佳实践" class="header-anchor">#</a> RESTFull 最佳实践</h1> <h2 id="嵌套路由"><a href="#嵌套路由" class="header-anchor">#</a> 嵌套路由</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>有时路由涉及到很多业务模块，可能需要对模块进行拆分和嵌套，koa-router 提供了路由嵌套的功能，使用也很简单，就是创建两个 Router 实例，然后将被嵌套的模块路由作为父级路由的中间件使用</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'prefix'</span><span class="token operator">:</span> <span class="token string">'/questions/:questionId/answer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过 answerSchema 的设计,设计 questionId 字段，实现一个问题 id 对应多个答案， 多个答案也可以映射一个问题，实现一对多的关系。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> answerSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    __v<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Number<span class="token punctuation">,</span> select<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    answerer<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> select<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 用 questionId 表示从属于某一个问题</span>
    questionId<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//  新增相关 问题（questionId）的回答，通过 token 绑定 answer</span>
<span class="token constant">POST</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'localhost:3001/questions/5feae88fc9a2196eb54cdc66/answer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取特定 问题（questionId）的回答</span>
<span class="token constant">GET</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>'localhost<span class="token operator">:</span><span class="token number">3001</span><span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">5</span>feae88fc9a2196eb54cdc66<span class="token operator">/</span>answer<span class="token operator">/</span>问题id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5fed44531832d12d63499bd2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;简单的说 Node.js 就是运行在服务端的 JavaScript&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;questionId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5feae88fc9a2196eb54cdc66&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5fed450b1832d12d63499bd3&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Node.js 是一个基于Chrome JavaScript 运行时建立的一个平台&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;questionId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5feae88fc9a2196eb54cdc66&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token comment">// 获取特定 问题（questionId）的特定回答相关所有属性</span>
<span class="token constant">GET</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>'localhost<span class="token operator">:</span><span class="token number">3001</span><span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">5</span>feae88fc9a2196eb54cdc66<span class="token operator">/</span>answer<span class="token operator">/</span>问题id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">{</span>
    <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5fed44531832d12d63499bd2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;简单的说 Node.js 就是运行在服务端的 JavaScript&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;answerer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;gender&quot;</span><span class="token operator">:</span> <span class="token string">&quot;male&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5fe59742e7d610dcfaba571f&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;李雷&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;questionId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5feae88fc9a2196eb54cdc66&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 修改相关 问题（questionId）的特定回答</span>
<span class="token constant">PATCH</span> axios<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>'localhost<span class="token operator">:</span><span class="token number">3001</span><span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">5</span>feae88fc9a2196eb54cdc66<span class="token operator">/</span>answer<span class="token operator">/</span>问题id<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="互斥接口"><a href="#互斥接口" class="header-anchor">#</a> 互斥接口</h2> <p>将控制器看作是一个中间件，以赞和踩为互斥关系为例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 赞 添加 next 使其成为中间件</span>
<span class="token keyword">async</span> <span class="token function">likeAnswer</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> me <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'+likeingAnswers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>me<span class="token punctuation">.</span>likeingAnswers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=&gt;</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        me<span class="token punctuation">.</span>likeingAnswers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        me<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> Answer<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> $inc<span class="token operator">:</span> <span class="token punctuation">{</span> voteCount<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 踩 添加 next 使其成为中间件</span>
<span class="token keyword">async</span> <span class="token function">disLikeAnswer</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> me <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'+disLikeingAnswers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>me<span class="token punctuation">.</span>disLikeingAnswers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=&gt;</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        me<span class="token punctuation">.</span>disLikeingAnswers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        me<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 点赞某个问题的时候，执行踩取消的操作</span>
router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/likeingAnswer/:id'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> checkAnswerExist<span class="token punctuation">,</span> likeAnswer<span class="token punctuation">,</span> unDisLikeAnswer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 点踩某个问题的时候，执行赞取消的操作</span>
router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/disLikeingAnswer/:id'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> checkAnswerExist<span class="token punctuation">,</span> disLikeAnswer<span class="token punctuation">,</span> unLikeAnswer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <h2 id="restful-api最佳实践"><a href="#restful-api最佳实践" class="header-anchor">#</a> RESTful API最佳实践</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用资源名词而不是动词实现RESTful API</p></div> <p>为了易于理解，为资源使用下面的API结构：</p> <table><thead><tr><th style="text-align:center;">Resource</th> <th style="text-align:center;">Getread</th> <th style="text-align:center;">Postcreate</th> <th style="text-align:center;">Putupdate</th> <th style="text-align:center;">Delete</th></tr></thead> <tbody><tr><td style="text-align:center;">/answer</td> <td style="text-align:center;">返回一个answer的列表</td> <td style="text-align:center;">创建一个新的answer</td> <td style="text-align:center;">更新answer的信息</td> <td style="text-align:center;">删除所有的answer</td></tr> <tr><td style="text-align:center;">/answer/2</td> <td style="text-align:center;">返回指定的answer</td> <td style="text-align:center;">Method not allowed(405)</td> <td style="text-align:center;">更新指定的</td> <td style="text-align:center;">answer的信息</td></tr></tbody></table> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 不要使用动词</span>
<span class="token operator">/</span>getAnswer
<span class="token operator">/</span>createAnswer
<span class="token operator">/</span>deleteAnswer

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'prefix'</span><span class="token operator">:</span> <span class="token string">'/questions/:questionId/answer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 使用名词 answer</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> find<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> checkAnswerExist<span class="token punctuation">,</span> findById<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> create<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> checkAnswerExist<span class="token punctuation">,</span> checkAnswerer<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> checkAnswerExist<span class="token punctuation">,</span> checkAnswerer<span class="token punctuation">,</span> del<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Get方法和查询参数不应该改变资源状态</p></div> <p>使用Put,Post和Delete方法替代Get方法来改变资源状态。不要使用Get来使状态改变</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">4</span><span class="token operator">?</span>answer or
<span class="token constant">GET</span> <span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">4</span><span class="token operator">/</span>answer
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用名词的复数形式</p></div> <p>不要混合使用单数和复数形式，而应该为所有资源一直保持使用复数形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">/</span>users instead <span class="token keyword">of</span> <span class="token operator">/</span>user
<span class="token operator">/</span>questions instead <span class="token keyword">of</span> <span class="token operator">/</span>question
<span class="token operator">/</span>comments instead <span class="token keyword">of</span> <span class="token operator">/</span>comment
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>为关系使用子资源</p></div> <p>假如资源连接到其它资源，则使用子资源形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 返回4号问题的答案列表</span>
<span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">4</span><span class="token operator">/</span>answers
<span class="token comment">// 返回4号问题的 id 为 11的答案</span>
<span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">4</span><span class="token operator">/</span>answers<span class="token operator">/</span><span class="token number">11</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用HTTP头决定序列化格式</p></div> <p>在客户端和服务端都需要知道使用什么格式来进行通信，这个格式应该在HTTP头中指定:</p> <ul><li>Content-Type：定义请求的格式；</li> <li>Accept ：定义允许的响应格式的列表</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用HATEOAS</p></div> <p>Hypermedia as the Engine of Application State是一个指导原则，它规定超文本链接应该被用于在API中创建更好的资源导航：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">711</span><span class="token punctuation">,</span>
  <span class="token string">&quot;manufacturer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bmw&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;model&quot;</span><span class="token operator">:</span> <span class="token string">&quot;X5&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;seats&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token string">&quot;drivers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
    <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;23&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Stefan Jauker&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;links&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{</span>
     <span class="token string">&quot;rel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;self&quot;</span><span class="token punctuation">,</span>
     <span class="token string">&quot;href&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/api/v1/drivers/23&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>为集合提供过滤、排序、字段选择以及分页</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">**</span>过滤<span class="token operator">**</span>
为所有字段或者查询语句提供独立的查询参数：
<span class="token comment">// 返回一个包含真不错的问题列表</span>
<span class="token constant">GET</span> <span class="token operator">/</span>questions<span class="token operator">?</span>q<span class="token operator">=</span><span class="token string">'真不错'</span>
<span class="token comment">// 返回最多2个回答的问题列表</span>
<span class="token constant">GET</span> <span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">4</span><span class="token operator">?</span>answers<span class="token operator">&lt;=</span><span class="token number">2</span>

<span class="token operator">**</span>排序<span class="token operator">**</span>
允许跨越多字段的正序或者倒序排列：
<span class="token constant">GET</span> <span class="token operator">/</span>questions<span class="token operator">?</span>sort<span class="token operator">=</span><span class="token operator">-</span>manufactorer<span class="token punctuation">,</span><span class="token operator">+</span>model

<span class="token operator">**</span>字段选择<span class="token operator">**</span>
一些情况下，我们只需要在列表中查询几个有标识意义的字段，我们不需要从服务端把所有字段的值都请求出来，所以需要支持<span class="token constant">API</span>选择查询字段的能力，这也可以提到网络传输性能和速度：
<span class="token constant">GET</span> <span class="token operator">/</span>questions<span class="token operator">/</span><span class="token number">4</span><span class="token operator">?</span>fields<span class="token operator">=</span>title<span class="token punctuation">;</span>description<span class="token punctuation">;</span>questioner<span class="token punctuation">;</span>topics

<span class="token operator">**</span>分页<span class="token operator">**</span>
使用page和per_page来获取固定数量的资源结果，当其中一个参数没有出现时，应该提供各自的默认值，比如默认取第一页，或者默认取<span class="token number">20</span>条数据：
<span class="token constant">GET</span> <span class="token operator">/</span>users<span class="token operator">?</span>page<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>per_page<span class="token operator">=</span><span class="token number">10</span>
<span class="token constant">GET</span> <span class="token operator">/</span>users<span class="token operator">?</span><span class="token operator">&amp;</span>per_page<span class="token operator">=</span><span class="token number">10</span> <span class="token comment">// 得到第一页的结果</span>
<span class="token constant">GET</span> <span class="token operator">/</span>users<span class="token operator">?</span><span class="token operator">&amp;</span>page<span class="token operator">=</span><span class="token number">2</span>  <span class="token comment">// 得到前20个结果</span>

使用自定义的头<span class="token constant">X</span><span class="token operator">-</span>Total<span class="token operator">-</span>Count发回给调用段实际的资源数量。

前一页后一页的链接也应该在<span class="token constant">HTTP</span>头链接中得到支持，遵从下文中的链接原则而不要构建你自己的头

Link<span class="token operator">:</span> <span class="token operator">&lt;</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>cars<span class="token operator">?</span>per_page<span class="token operator">=</span><span class="token number">15</span><span class="token operator">&amp;</span>page<span class="token operator">=</span><span class="token number">5</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> rel<span class="token operator">=</span><span class="token string">&quot;next&quot;</span><span class="token punctuation">,</span>
<span class="token operator">&lt;</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>cars<span class="token operator">?</span>per_page<span class="token operator">=</span><span class="token number">50</span><span class="token operator">&amp;</span>page<span class="token operator">=</span><span class="token number">3</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> rel<span class="token operator">=</span><span class="token string">&quot;last&quot;</span><span class="token punctuation">,</span>
<span class="token operator">&lt;</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>cars<span class="token operator">?</span>per_page<span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>page<span class="token operator">=</span><span class="token number">5</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> rel<span class="token operator">=</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span>
<span class="token operator">&lt;</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>cars<span class="token operator">?</span>per_page<span class="token operator">=</span><span class="token number">5</span><span class="token operator">&amp;</span>page<span class="token operator">=</span><span class="token number">5</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> rel<span class="token operator">=</span><span class="token string">&quot;prev&quot;</span>

<span class="token operator">**</span>版本化你的<span class="token constant">API</span><span class="token operator">**</span>
确保强制实行<span class="token constant">API</span>版本，并且不要发布一个没有版本的<span class="token constant">API</span>，使用简单的序列数字，避免使用<span class="token number">2.5</span><span class="token number">.0</span>这样的形式：

<span class="token operator">/</span>blog<span class="token operator">/</span>api<span class="token operator">/</span>v1

<span class="token operator">**</span>使用<span class="token constant">HTTP</span>状态码处理错误<span class="token operator">**</span>
忽略错误处理的<span class="token constant">API</span>是很难使用的，简单的返回<span class="token number">500</span>和调用堆栈是非常不友好也非常无用的：

<span class="token operator">/</span>使用<span class="token constant">HTTP</span>状态码<span class="token operator">/</span>

<span class="token constant">HTTP</span>标准提供了<span class="token number">70</span>多个状态码来描述返回值，我们不需要完全用到他们，下文中列出<span class="token number">10</span>个使用率较高的：

<span class="token number">200</span> – <span class="token constant">OK</span> – 一切正常
<span class="token number">201</span> – <span class="token constant">OK</span> – 新资源已经被创建
<span class="token number">204</span> – <span class="token constant">OK</span> – 资源删除成功

<span class="token number">304</span> – 没有变化，客户端可以使用缓存数据

<span class="token number">400</span> – Bad Request – 调用不合法，确切的错误应该在error payload中描述，例如：“<span class="token constant">JSON</span> 不合法 ”
<span class="token number">401</span> – 未认证，调用需要用户通过认证
<span class="token number">403</span> – 不允许的，服务端正常解析和请求，但是调用被回绝或者不被允许
<span class="token number">404</span> – 未找到，指定的资源不存在
<span class="token number">422</span> – 不可指定的请求体 – 只有服务器不能处理实体时使用，比如图像不能被格式化，或者重要字段丢失。

<span class="token number">500</span> – Internal Server Error – 标准服务端错误，<span class="token constant">API</span>开发人员应该尽量避开这种错误

<span class="token operator">/</span>使用 error payloads<span class="token operator">/</span>
所有的异常都应该被映射到error payloads中，下文中的例子是一个json payload的模板：
<span class="token punctuation">{</span>
  <span class="token string">&quot;errors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
    <span class="token string">&quot;userMessage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Sorry, the requested resource does not exist&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;internalMessage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;No car found in the database&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">34</span><span class="token punctuation">,</span>
    <span class="token string">&quot;more info&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://dev.mwaysolutions.com/blog/api/v1/errors/12345&quot;</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>允许重写HTTP方法</p></div> <p>一些代理只支持GET和POST方法，为了在这种限制下支持RESTful API，API需要重写HTTP方法。</p> <p>使用自定义的X-HTTP-Method-Override  HTTP头来重写POST方法。</p> <hr> <h2 id="分页设计、模糊搜索、多字段模糊搜索实践"><a href="#分页设计、模糊搜索、多字段模糊搜索实践" class="header-anchor">#</a> 分页设计、模糊搜索、多字段模糊搜索实践</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果你需要在MongoDB中读取指定数量的数据记录</span>
<span class="token comment">// 例如： 通过 imit()方法接受一个数字参数，该参数指定从MongoDB中读取的记录条数。</span>
<span class="token comment">// kip()方法来跳过指定数量的数据，skip方法同样接受一个数字参数作为跳过的记录条数。</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> q<span class="token punctuation">,</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> per_page <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
<span class="token keyword">const</span> pageSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>page <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> perPage <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>per_page <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> content<span class="token operator">:</span> q <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>perPage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>pageSize <span class="token operator">*</span> perPage<span class="token punctuation">)</span>

<span class="token comment">// 通过正则表达式 new RegExp 平匹配字符串</span>
<span class="token keyword">const</span> keyword <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> content<span class="token operator">:</span> keyword <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>perPage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>pageSize <span class="token operator">*</span> perPage<span class="token punctuation">)</span>

<span class="token comment">// 多字段模糊匹配 $or</span>
<span class="token keyword">const</span> keyword <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> $or<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> title<span class="token operator">:</span> keyword <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> description<span class="token operator">:</span> keyword <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>perPage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>pageSize <span class="token operator">*</span> perPage<span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">8/8/2022, 2:43:56 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-notes/koa2/schema.html" class="prev">
        数据模型的应用
      </a></span> <span class="next"><a href="/study-notes/koa2/database-design.html">
        数据库设计
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study-notes/assets/js/app.039e21f8.js" defer></script><script src="/study-notes/assets/js/2.c66ffe4c.js" defer></script><script src="/study-notes/assets/js/74.8debcd50.js" defer></script>
  </body>
</html>
