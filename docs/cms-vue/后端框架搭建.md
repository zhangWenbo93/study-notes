# åç«¯æ¡†æ¶æ­å»º

## Koaç®€ä»‹

::: tip
[æºç ](https://github.com/koajs/koa)
:::

Koa æ˜¯ä¸€ä¸ªæ–°çš„ web æ¡†æ¶ï¼Œç”± Express å¹•åçš„åŸç­äººé©¬æ‰“é€ ï¼Œ è‡´åŠ›äºæˆä¸º web åº”ç”¨å’Œ API å¼€å‘é¢†åŸŸä¸­çš„ä¸€ä¸ªæ›´å°ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›ã€æ›´å¥å£®çš„åŸºçŸ³ã€‚ é€šè¿‡åˆ©ç”¨ async å‡½æ•°ï¼ŒKoa å¸®ä½ ä¸¢å¼ƒå›è°ƒå‡½æ•°ï¼Œå¹¶æœ‰åŠ›åœ°å¢å¼ºé”™è¯¯å¤„ç†ã€‚ Koa å¹¶æ²¡æœ‰æ†ç»‘ä»»ä½•ä¸­é—´ä»¶ï¼Œ è€Œæ˜¯æä¾›äº†ä¸€å¥—ä¼˜é›…çš„æ–¹æ³•ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿè€Œæ„‰å¿«åœ°ç¼–å†™æœåŠ¡ç«¯åº”ç”¨ç¨‹åºã€‚

## é¡¹ç›®åˆå§‹åŒ–

åˆ›å»ºé¡¹ç›®

```js
mkdir books-cms
cd books-cms
npm init
```

å®‰è£…ä¾èµ–

```js
npm i -S Koa
```

åˆ›å»º app.js

```js
const path = require('path')
const Koa = require('koa')

const app = new Koa()
const isDev = process.env.NODE_ENV === 'production'
const host = isDev ? '0.0.0.0' : process.env.HOST || '127.0.0.1'
const port = process.env.PORT || '3003'

app.listen(port, host, () => {
    console.log('é¡¹ç›®å·²å¯åŠ¨åœ¨ http://%s:%s', host, port)
})
```

## æ–‡ä»¶ç»“æ„

```sh
books-cms

â”œâ”€ app
â”‚  â”œâ”€ api  # api å±‚
â”‚  â”‚  â””â”€ v1  # æ™®é€šapi
â”‚  â”‚     â””â”€ book.js
â”‚  â”œâ”€ controller  # controller å±‚
â”‚  â”‚  â””â”€ v1
â”‚  â”‚     â””â”€ books.js
â”‚  â”œâ”€ models # models æ¨¡å‹å±‚
â”‚  â”‚  â””â”€ user.js
â”‚  â””â”€ validator # æ ¡éªŒå±‚
â”‚     â””â”€ validator.js # æ ¡éªŒå™¨æ¨¡å—
â”œâ”€ app.js # åˆ›å»ºkoaå®ä¾‹åŠåº”ç”¨æ‰©å±•
â”œâ”€ config # é…ç½®æ–‡ä»¶ç›®å½•
â”‚  â””â”€ config.js # æ•°æ®åº“ç›¸å…³é…ç½®
â”œâ”€ core # å…¶å®ƒç±»åº“
â”‚  â”œâ”€ db.js # Sequelize å®ä¾‹
â”‚  â”œâ”€ http-exception.js # å¼‚å¸¸ç±»åº“
â”‚  â”œâ”€ init.js  # åˆå§‹åŒ–å‡½æ•°
â”‚  â”œâ”€ lin-validator.js # æ ¡éªŒç±»åº“
â”‚  â””â”€ util.js  # åŠ©æ‰‹å‡½æ•°
â”œâ”€ jsconfig.json
â”œâ”€ middlewares # ä¸­é—´ä»¶ç›®å½•
â”‚  â”œâ”€ auth.js
â”‚  â””â”€ exception.js
â”œâ”€ package-lock.json
â””â”€ package.json
```

## é¡¹ç›®æ­å»º

å…¨å±€è·¯ç”±è‡ªåŠ¨æ³¨å†Œ `core/init.js`

```js
const Router = require('koa-router');
const { get } = require('lodash');
const requireDirectory = require('require-directory');

class InitManager {
    static initCore(app) {
        InitManager.app = app;
        InitManager.initLoadRouter();
    }

    static initLoadRouter() {
        //  è·¯ç”±è‡ªåŠ¨æ³¨å†Œ
        requireDirectory(module, `${process.cwd()}/app/api`, {
            visit: whenModuleLoad
        });

        function whenModuleLoad(route) {
            if (route instanceof Router) {
                InitManager.app.use(route.routes()).use(route.allowedMethods());
            }
        }
    }

    static initLoadError() {
        // å…¨å±€é”™è¯¯æ³¨å†Œ
        const errors = require('./http-exception');
        global.errs = errors;
    }
}

module.exports = InitManager;
```

è¯·æ±‚ç›¸å…³é”™è¯¯å®šä¹‰ `core/http-exception.js`

```js
/**
 * @description ç»§æ‰¿æ¥è‡ªNodeè‡ªèº«çš„é”™è¯¯å±æ€§
 * @date 2021-04-01
 * @class HttpException
 * @extends {Error}
 */
class HttpException extends Error {
    constructor(msg = 'æœåŠ¡å™¨å¼‚å¸¸', errorCode = 10000, code = 400) {
        super();
        this.msg = msg;
        this.errorCode = errorCode;
        this.code = code;
    }
}
/**
 * @description èµ„æºæœªæ‰¾åˆ°
 * @date 2021-04-01
 * @class NotFound
 * @extends {HttpException}
 */
class NotFound extends HttpException {
    constructor(msg, errorCode) {
        super();
        this.msg = msg || 'èµ„æºæœªæ‰¾åˆ°';
        this.errorCode = errorCode || 10000;
        this.code = 404;
    }
}
/**
 * @description å‚æ•°ä¸æ­£ç¡®
 * @date 2021-04-01
 * @class ParameterException
 * @extends {HttpException}
 */
class ParameterException extends HttpException {
    constructor(msg, errorCode) {
        super();
        this.msg = msg || 'å‚æ•°ä¸æ­£ç¡®';
        this.errorCode = errorCode || 10000;
        this.code = 400;
    }
}
/**
 * @description æ¥å£è¯·æ±‚æˆåŠŸ
 * @date 2021-04-01
 * @class Success
 * @extends {HttpException}
 */
class Success extends HttpException {
    constructor(msg, errorCode) {
        super();
        this.msg = msg || 'ok';
        this.errorCode = errorCode || 0;
        this.code = 201;
    }
}
/**
 * @description æ— æƒé™è®¿é—®
 * @date 2021-04-01
 * @class Forbbiden
 * @extends {HttpException}
 */
class Forbbiden extends HttpException {
    constructor(msg, errorCode) {
        super();
        this.msg = msg || 'ç¦æ­¢è®¿é—®';
        this.errorCode = errorCode || 10006;
        this.code = 403;
    }
}

module.exports = {
    HttpException,
    NotFound,
    ParameterException,
    Success,
    Forbbiden
};

```

å…¨å±€é”™è¯¯å¼‚å¸¸å¤„ç† `middlewares/exception.js`

```js
const { HttpException } = require('@core/http-exception');

const catchError = async (ctx, next) => {
    try {
        await next();
    } catch (error) {
        const isHttpException = error instanceof HttpException;
        const isDev = process.env.NODE_ENV !== 'production';
        if (isDev && !isHttpException) {
            throw error;
        }
        if (isHttpException) {
            // å·²çŸ¥é”™è¯¯ï¼Œå³å·²å®šä¹‰çš„é”™è¯¯
            ctx.body = {
                msg: error.msg,
                err_code: error.errCode,
                request: `${ctx.method}${ctx.path}`
            };
            ctx.status = error.status;
        } else {
            // æœªçŸ¥çš„  æœªå®šä¹‰çš„é”™è¯¯
            ctx.body = {
                msg: 'æœªçŸ¥å¼‚å¸¸ğŸ˜‚',
                err_code: 999,
                request: `${ctx.method}${ctx.path}`
            };
            ctx.status = error.status;
        }
    }
};

module.exports = catchError;
```

è·¯ç”±ã€é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ³¨å†Œ

```js
const path = require('path')
const Koa = require('koa')
const KoaBody = require('koa-body')
const KoaStatic = require('koa-static')
const InitManager = require('@core/init')
const catchError = require('@middlewares/exception')

const app = new Koa()
const isDev = process.env.NODE_ENV === 'production'
const host = isDev ? '0.0.0.0' : process.env.HOST || '127.0.0.1'
const port = process.env.PORT || '3003'

// é”™è¯¯æœºåˆ¶ä¸­é—´ä»¶åœ¨æœ€å‰é¢æ³¨å†Œ
app.use(catchError)
app.use(KoaBody())
// åˆå§‹åŒ–è‡ªåŠ¨åŠ è½½è·¯ç”±
InitManager.initCore(app)

app.listen(port, host, () => {
    console.log('é¡¹ç›®å·²å¯åŠ¨åœ¨ http://%s:%s', host, port)
})
```

## åˆ«åè·¯å¾„é…ç½®

- å®‰è£…module-alias

```js
npm install module-alias --save
```

- ä½¿ç”¨module-alias

åœ¨ `package.json` ä¸­å¼•å…¥ï¼Œè¿™é‡Œ@rootå°±æ˜¯åˆ«åï¼Œåé¢å¼•å·å†…çš„å†…å®¹å°±æ˜¯åŸè·¯å¾„

```js
  "_moduleAliases": {
    "@root": ".",
    "@models": "app/models",
    "@core": "core",
    "@middlewares": "middlewares",
    "@validator": "app/validator/validator.js",
    "@services": "app/services",
    "@lib": "app/lib",
    "@config": "config/config.js",
    "@controller": "app/controller"
  }
```

é…ç½®æ–‡ä»¶å¼•å…¥ `require(â€˜module-alias/registerâ€™)`ï¼Œå»ºè®®åœ¨ `app.js` åˆå§‹åŒ–ä¸­å¼•å…¥ï¼Œæ”¾åœ¨ç¬¬ä¸€è¡Œ

```js
require('module-alias/register')
const path = require('path')
const Koa = require('koa')
```

- tsåšç‰¹æ®Šæ˜ å°„

åœ¨ `tsconfig.json` æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„æ˜ å°„

```js
touch tsconfig.json

{
    "compilerOptions": {
        "baseUrl": "./",
        "paths": {
            "@models/*": [
                "app/models/*"
            ],
            "@core/*": [
                "core/*"
            ],
            "@middlewares/*": [
                "middlewares/*"
            ],
            "@validator": [
                "app/validator/validator.js"
            ],
            "@services/*": [
                "app/services/*"
            ],
            "@lib/*": [
                "app/lib/*"
            ],
            "@config": [
                "config/config.js"
            ],
            "@controller/*": [
                "app/controller/*"
            ]
        }
    },
    "exclude": [
        "node_modules",
        "dist"
    ]
}
```

åç«¯æ¡†æ¶å·²ç»åˆæ­¥æ­å»ºå®Œæ¯•ï¼Œå¯ä»¥ä¸Šè·¯ã€‚
